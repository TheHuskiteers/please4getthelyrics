<!DOCTYPE html>
<html>
<head>
  <title>Please 4get The Lyrics</title>
</head>
<link rel="stylesheet" href="/css/host.css">
<body>
  <div class="container1">
    <h1 id="waiting">Waiting for players to join...</h1>
    <h3 id="curPlayers">Current players: 0</h3>
  </div>

  <div class="container2">
    <h2>Karaoke Room ID:</h2>
    <p id="code">Loading...</p>
  </div>

  <button class="btn" onclick="">Start game!</button>

  <script>
    if (document.cookie.indexOf('token') == -1) {
	window.location = "http://localhost:3000/login"
    }
    const token = document.cookie.replace(/(?:(?:^|.*;\s*)token\s*\=\s*([^;]*).*$)|^.*$/, "$1");
    var did;
  </script>
  <script src="https://sdk.scdn.co/spotify-player.js"></script>
  <script>    
    window.onSpotifyWebPlaybackSDKReady = () => {
	var player = new Spotify.Player({
	    name: "Please 4get These Lyrics",
	    getOAuthToken: cb => { cb(token); }
	});

	player.addListener('ready', ({ device_id }) => {
	    did = device_id;
	});
	
	player.connect();
    };
    
    const play = (uri, pos) => {
	fetch('https://api.spotify.com/v1/me/player/play?device_id=' + did, {
	    method: 'put',
	    body: JSON.stringify({ uris: [uri], position_ms: pos }),
	    headers: {
		'Content-Type': 'application/json',
		'Authorization': 'Bearer ' + token
	    }
	}).then(res => console.log(res));
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/socket.io-client@2/dist/socket.io.js" charset="utf-8"></script>
  <script type="text/javascript">
    var socket = io();
    function createGame() {
      socket.emit('host join');
    }

    // keep track of clients as they join
    document.getElementsByClassName("btn")[0].disabled = true;
    socket.on('create game success', (info) => {
        console.log(info);
        document.getElementById("code").innerHTML = info.roomId;
        document.getElementById("curPlayers").innerHTML = "Current players: " + info.clients.length;

        if (info.clientLength == 0) {
          document.getElementsByClassName("btn")[0].disabled = true;
        } else {
          document.getElementsByClassName("btn")[0].disabled = false;
        }
    });
    socket.on('update pregame info', (info) => {
      console.log(info);
    })
    createGame();
  </script>
</body>
</html>
