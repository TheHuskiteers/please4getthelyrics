<!DOCTYPE html>
<html>
<head>
  <title>Please 4get The Lyrics</title>
</head>
<link rel="stylesheet" href="/css/host.css">
<body>
  <div id="joining">
    <div class="container1">
      <h1 id="waiting">Waiting for players to join...</h1>
      <p>Socket countdown should go here</p>
    </div>

    <div class="container2">
      <h2>Karaoke Room ID:</h2>
      <p id="code">Room ID should go here</p>
    </div>
  </div>

  <div id="playing">
    <h1>Song # {}</h1>
    <h2>Player {}'s turn</h2>

    <div id="trackImg"></div> <!-- Image of the song's album cover goes here? -->

    <h4 id="waiting">Wait for it...</h4>
    <h3 id="singing">FORGET THOSE LYRICS!</h3>

    <!-- Choose a song from the local directory of songs -->
    <!-- Fetch the song cover image using Spotify API -->
    <!-- Based on lyrics, a random start/end timestamp (and corresponding lyrics) are chosen -->
    <!-- We need to make sure Spotify's audio and timestamps are synced properly -->
    <!-- Play Spotify web player until the first timestamp, then music pauses -->
    <!-- Prompt sent to Player x to record their voice. User's device determines if voice matches the lyrics -->
    <!-- If so, User sends back True. Otherwise, sends back False -->
    <!-- Server awards a point depending on correctness, and moves onto the next player/song -->
  </div>


  <script>
    if (document.cookie.indexOf('token') == -1) {
	window.location = "http://localhost:3000/login"
    }
  </script>

  <script src="https://sdk.scdn.co/spotify-player.js"></script>
  <script>
    window.onSpotifyWebPlaybackSDKReady = () => {};
    async function waitForSpotifyWebPlaybackSDKToLoad () {
	return new Promise(resolve => {
	    if (window.Spotify) {
		resolve(window.Spotify);
	    } else {
		window.onSpotifyWebPlaybackSDKReady = () => {
		    resolve(window.Spotify);
		};
	    }
	});
    };
    
    var sdk = (async () => {
	const { Player } = await waitForSpotifyWebPlaybackSDKToLoad();
	const sdk = new Player({
	    name: "Please 4get These Lyrics",
	    getOAuthToken: callback => { callback(document.cookie.replace(/(?:(?:^|.*;\s*)token\s*\=\s*([^;]*).*$)|^.*$/, "$1")); }	
	});
	console.log(sdk);

	let connected = await sdk.connect();
	if (connected) {
	    fetch("https://api.spotify.com/v1/me/player", {
		method: 'put',
		body: JSON.stringify({ device_ids: [sdk.id] }),
		headers: {
		    'Content-Type': 'application/json',
		    'Authorization': 'Bearer ' + sdk._options.id,
		}
	    })
	}
	return sdk
    })();

    const play = (uri, pos) => {
	var o = (async () => (await sdk)._options)();
	console.log(o);
	fetch('https://api.spotify.com/v1/me/player/play?device_id=' + o.id, {
	    method: 'put',
	    body: JSON.stringify({ uris: [uri], position_ms: pos }),
	    headers: {
		'Content-Type': 'application/json',
		'Authorization': 'Bearer ' + o.getOAuthToken
	    }
	});
    };
  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/socket.io-client@2/dist/socket.io.js" charset="utf-8"></script>
  <script type="text/javascript">
  var socket = io();
  function createGame() {
    socket.emit('host join');
    console.log("game creating");
  }
  socket.on('host room info', (info) => {
      console.log(info);
  })
  createGame();
  </script>
</body>
</html>
